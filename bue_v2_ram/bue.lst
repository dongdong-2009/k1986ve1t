ARM GAS  dsp.s 			page 1


   1              	.global dot3
   2              	.global mfilter
   3              	.global dq_to_abc
   4              	.global abc_to_dq
   5              	.global asm_test_loop
   6              	
   7              	.section .data
   8 0000 00000000 	flt_acm:	.word 0
   9 0004 00000000 	flt_idx:	.word 0
  10 0008 00000000 	flt_buf:	.skip 32*4, 0
  10      00000000 
  10      00000000 
  10      00000000 
  10      00000000 
  11              	
  12              	.section .text
  13              	
  14              	@; r0 - v[]
  15              	@; r1 - *ang
  16              	@; r2 - *mag
  17              	asm_test_loop:
  18 0000 70B5     		push {r4,r5,r6,lr}
  19              	
  20 0002 5B40     		eor		r3,r3	
  21 0004 0468     		ldr		r4,[r0]
  22 0006 002C     		cmp		r4,#0
  23              	
  24              		
  25              		
  26              	/*loop:
  27              		sub r0,r0,#1
  28              		bpl loop
  29              	*/	
  30              	
  31              		
  32 0008 70BD     		pop {r4,r5,r6,pc}
  33              	
  34 000a 80000000 	AngTable:	.word 128, 76, 40, 20, 10, 5, 3, 1					@; angles for those tg =0.5,0.25 etc
  34      4C000000 
  34      28000000 
  34      14000000 
  34      0A000000 
  35 002a D4020000 	kc:			.word 724, 648, 628, 623, 623, 622, 622, 622 		@; mag correction cos(ang)
  35      88020000 
  35      74020000 
  35      6F020000 
  35      6F020000 
  36              	
  37              	@; r0 - abc[]
  38              	@; r1 - dq[]
  39              	@; r2 - angle
  40              	abc_to_dq:
  41 004a 70B5     		push {r4,r5,r6,lr}
  42              	
  43 004c 4A4B     		ldr r3, =cos_tb 	
  44 004e 9200     		lsl r2,#2
  45              	
ARM GAS  dsp.s 			page 2


  46              		@; calculate dq[0]
  47 0050 9C58     		ldr r4,[r3,r2]			@; r4 = cos_tb[angle]
  48 0052 0568     		ldr r5,[r0]				@; r5 = abc[0]	
  49 0054 6C43     		mul r4,r4,r5			@; r4 = abc[0]*cos_tb[angle]
  50              		
  51 0056 334E     		ldr r6,P_4PI3
  52 0058 B618     		add r6,r6,r2
  53 005a 364D     		ldr r5,MASK1023
  54 005c 3540     		and r5,r6
  55 005e 5E59     		ldr r6,[r3,r5]			@; r6 = cos_tb[angle+4*512/3]
  56 0060 4568     		ldr r5,[r0,#4]			@; r5 = abc[1]
  57 0062 7543     		mul r5,r5,r6			@; r5 = abc[1]*cos_tb[angle+4*512/3]	
  58 0064 6419     		add r4,r4,r5			@; r4 = abc[0]*cos_tb[angle] + abc[1]*cos_tb[angle+4*512/3]
  59              		
  60 0066 304E     		ldr r6,P_2PI3
  61 0068 B618     		add r6,r6,r2
  62 006a 324D     		ldr r5,MASK1023
  63 006c 3540     		and r5,r6
  64 006e 5E59     		ldr r6,[r3,r5]			@; r6 = cos_tb[angle+2*512/3]
  65 0070 8568     		ldr r5,[r0,#8]			@; r5 = abc[2]
  66 0072 7543     		mul r5,r5,r6			@; r5 = abc[2]*cos_tb[angle+2*512/3]	
  67 0074 6419     		add r4,r4,r5			@; r4 = abc[0]*cos_tb[angle] + abc[1]*cos_tb[angle+4*512/3] + abc[2]*cos_tb[angle+2
  68              		
  69 0076 A412     		asr r4,#10
  70 0078 0C60     		str r4,[r1]				@; dq[0] = r4
  71              		
  72              		@; calculate dq[1]
  73 007a 294E     		ldr r6,P_3PI2
  74 007c B618     		add r6,r6,r2
  75 007e 2D4D     		ldr r5,MASK1023
  76 0080 3540     		and r5,r6
  77 0082 5E59     		ldr r6,[r3,r5]			@; r6 = sin[angle]
  78 0084 0468     		ldr r4,[r0]				@; r4 = abc[0]
  79 0086 7443     		mul r4,r4,r6			@; r4 = abc[0]*sin[angle]
  80              		
  81 0088 284E     		ldr r6,P_4PI33PI2
  82 008a B618     		add r6,r6,r2
  83 008c 294D     		ldr r5,MASK1023
  84 008e 3540     		and r5,r6
  85 0090 5E59     		ldr r6,[r3,r5]			@; r6 = sin[angle+4*512/3]
  86 0092 4568     		ldr r5,[r0,#4]			@; r5 = abc[1]
  87 0094 7543     		mul r5,r5,r6			@; r5 = abc[1]*sin[angle+4*512/3]	
  88 0096 6419     		add r4,r4,r5			@; r4 = abc[0]*sin[angle] + abc[1]*sin[angle+4*512/3]
  89              		
  90 0098 254E     		ldr r6,P_2PI33PI2
  91 009a B618     		add r6,r6,r2
  92 009c 254D     		ldr r5,MASK1023
  93 009e 3540     		and r5,r6
  94 00a0 5E59     		ldr r6,[r3,r5]			@; r6 = sin[angle+2*512/3]
  95 00a2 8568     		ldr r5,[r0,#8]			@; r5 = abc[2]
  96 00a4 7543     		mul r5,r5,r6			@; r5 = abc[2]*sin[angle+2*512/3]	
  97 00a6 6419     		add r4,r4,r5			@; r4 = abc[0]*sin[angle] + abc[1]*sin[angle+4*512/3] + abc[2]*sin[angle+2*512/3]
  98              		
  99 00a8 A412     		asr r4,#10
 100 00aa 7640     		eor r6,r6
 101 00ac 361B     		sub r6,r4
 102 00ae 4E60     		str r6,[r1,#4]			@; dq[1] = r4		
ARM GAS  dsp.s 			page 3


 103              		
 104 00b0 70BD     		pop {r4,r5,r6,pc}
 105              	
 106              	
 107              	@; r0 - abc[]
 108              	@; r1 - dq[]
 109              	@; r2 - angle
 110              	dq_to_abc:
 111 00b2 70B5     		push {r4,r5,r6,lr}
 112              	
 113 00b4 304B     		ldr r3, =cos_tb 	
 114 00b6 9200     		lsl r2,#2
 115              	
 116              		@ abc[0]
 117 00b8 9C58     		ldr r4,[r3,r2]			@; r4 = cos_tb[angle]	
 118 00ba 0D68     		ldr r5,[r1]				@; r5 = dq[0]	
 119 00bc 6C43     		mul r4,r4,r5			@; r4 = dq[0]*cos_tb[angle]
 120              			
 121 00be 184E     		ldr r6,P_3PI2
 122 00c0 B618     		add r6,r6,r2
 123 00c2 1C4D     		ldr r5,MASK1023
 124 00c4 3540     		and r5,r6
 125 00c6 5E59     		ldr r6,[r3,r5]			@; r6 = cos_tb[angle+3*512/2]
 126 00c8 4D68     		ldr r5,[r1,#4]			@; r5 = dq[1]
 127 00ca 7543     		mul r5,r5,r6			@; r5 = dq[1]*cos_tb[angle+3*512/2]
 128              	
 129 00cc 641B     		sub r4,r4,r5			@; r4 = dq[0]*cos_tb[angle] - dq[1]*cos_tb[angle+3*512/2]	
 130 00ce 2415     		asr r4,#20				
 131 00d0 0460     		str r4,[r0]				@; abc[0] = (dq[0]*cos_tb[angle] - dq[1]*cos_tb[angle+3*512/2]) >> 20
 132              			
 133              		@ abc[1]
 134 00d2 144E     		ldr r6,P_4PI3
 135 00d4 B618     		add r6,r6,r2
 136 00d6 174D     		ldr r5,MASK1023
 137 00d8 3540     		and r5,r6
 138 00da 5C59     		ldr r4,[r3,r5]			@; r4 = cos_tb[angle+4*512/3]
 139 00dc 0D68     		ldr r5,[r1]				@; r5 = dq[0]
 140 00de 6C43     		mul r4,r4,r5			@; r4 = dq[0]*cos_tb[angle+4*512/3]
 141              		
 142 00e0 124E     		ldr r6,P_4PI33PI2
 143 00e2 B618     		add r6,r6,r2
 144 00e4 134D     		ldr r5,MASK1023
 145 00e6 3540     		and r5,r6
 146 00e8 5E59     		ldr r6,[r3,r5]			@; r6 = cos_tb[angle+4*512/3+3*512/2]
 147 00ea 4D68     		ldr r5,[r1,#4]			@; r5 = dq[1]
 148 00ec 7543     		mul r5,r5,r6			@; r5 = dq[1]*cos_tb[angle+4*512/3+3*512/2]
 149              		
 150 00ee 641B     		sub r4,r4,r5			@; r4 = dq[0]*cos_tb[angle+4*512/3] - dq[1]*cos_tb[angle+4*512/3+3*512/2]	
 151 00f0 2415     		asr r4,#20				
 152 00f2 4460     		str r4,[r0,#4]	
 153              		
 154              		@ abc[2]
 155 00f4 0C4E     		ldr r6,P_2PI3
 156 00f6 B618     		add r6,r6,r2
 157 00f8 0E4D     		ldr r5,MASK1023
 158 00fa 3540     		and r5,r6
 159 00fc 5C59     		ldr r4,[r3,r5]	
ARM GAS  dsp.s 			page 4


 160 00fe 0D68     		ldr r5,[r1]		
 161 0100 6C43     		mul r4,r4,r5	
 162              		
 163 0102 0B4E     		ldr r6,P_2PI33PI2
 164 0104 B618     		add r6,r6,r2
 165 0106 0B4D     		ldr r5,MASK1023
 166 0108 3540     		and r5,r6
 167 010a 5E59     		ldr r6,[r3,r5]	
 168 010c 4D68     		ldr r5,[r1,#4]	
 169 010e 7543     		mul r5,r5,r6	
 170              		
 171 0110 641B     		sub r4,r4,r5		
 172 0112 2415     		asr r4,#20				
 173 0114 8460     		str r4,[r0,#8]		
 174              		
 175 0116 70BD     		pop {r4,r5,r6,pc}
 176              	
 177              	
 178 0118 C046C046 	.align 4
 178      C046C046 
 179 0120 000C0000 	P_3PI2:		.word (4*3*512)/2
 180 0124 AA0A0000 	P_4PI3:		.word 4*4*512/3
 181 0128 55050000 	P_2PI3:		.word 4*2*512/3
 182 012c AA160000 	P_4PI33PI2:	.word 4*4*512/3+4*3*512/2
 183 0130 55110000 	P_2PI33PI2:	.word 4*2*512/3+4*3*512/2
 184 0134 FC0F0000 	MASK1023:   .word 4*1023
 185              	
 186              	mfilter:
 187              							@; r0=x
 188 0138 1049     		ldr r1, =flt_idx
 189 013a 0A68     		ldr r2, [r1] 
 190 013c 0132     		add r2,r2,#1
 191 013e 1F23     		mov r3,#(32-1)
 192 0140 1A40     		and r2,r3	 		@; r2 = i
 193 0142 0A60     		str r2, [r1]		
 194              			
 195 0144 0E49     		ldr r1, =flt_buf
 196 0146 9200     		lsl r2,#2
 197 0148 8918     		add r1, r1, r2		 @; r1=&b[i]	
 198 014a 0A68     		ldr r2,[r1]			 @; r2=b[i](old)
 199 014c 0860     		str r0,[r1]			 @; b[i](new)=x		
 200 014e 801A     		sub r0,r0,r2		 @; r0=x-b[i]				
 201              	
 202 0150 0C49     		ldr r1, =flt_acm
 203 0152 0A68     		ldr r2,[r1]
 204 0154 8018     		add r0,r0,r2		 @ r0 = a+x-b[i](old)	
 205 0156 0860     		str r0,[r1]
 206 0158 4011     		asr r0,r0,#5		 @ r0 = ( a+x-b[i](old) )/32
 207              		
 208 015a F746     		mov pc,lr
 209              	
 210              	dot3:
 211 015c 80B5     		push {r7,lr}
 212              		
 213 015e 0268     		ldr r2,[r0,#0]
 214 0160 0B68     		ldr r3,[r1,#0]
 215 0162 5A43     		mul r2,r2,r3
ARM GAS  dsp.s 			page 5


 216 0164 171C     		mov r7,r2
 217              		
 218 0166 4268     		ldr r2,[r0,#4]
 219 0168 4B68     		ldr r3,[r1,#4]
 220 016a 5A43     		mul r2,r2,r3	
 221 016c BF18     		add r7,r7,r2
 222              		
 223 016e 8068     		ldr r0,[r0,#8]
 224 0170 8B68     		ldr r3,[r1,#8]
 225 0172 5843     		mul r0,r0,r3	
 226 0174 3818     		add r0,r7,r0	
 227              		
 228 0176 80BD0000 		pop {r7,pc}
 228      00000400 
 228      00000800 
 228      00000000 
 228      0000
ARM GAS  dsp.s 			page 6


DEFINED SYMBOLS
               dsp.s:210    .text:0000015c dot3
               dsp.s:186    .text:00000138 mfilter
               dsp.s:110    .text:000000b2 dq_to_abc
               dsp.s:40     .text:0000004a abc_to_dq
               dsp.s:17     .text:00000000 asm_test_loop
               dsp.s:8      .data:00000000 flt_acm
               dsp.s:9      .data:00000004 flt_idx
               dsp.s:10     .data:00000008 flt_buf
               dsp.s:10     .data:00000008 $d
               dsp.s:18     .text:00000000 $t
               dsp.s:34     .text:0000000a AngTable
               dsp.s:34     .text:0000000a $d
               dsp.s:35     .text:0000002a kc
               dsp.s:41     .text:0000004a $t
               dsp.s:180    .text:00000124 P_4PI3
               dsp.s:184    .text:00000134 MASK1023
               dsp.s:181    .text:00000128 P_2PI3
               dsp.s:179    .text:00000120 P_3PI2
               dsp.s:182    .text:0000012c P_4PI33PI2
               dsp.s:183    .text:00000130 P_2PI33PI2
               dsp.s:179    .text:00000120 $d
               dsp.s:188    .text:00000138 $t
               dsp.s:228    .text:00000178 $d

UNDEFINED SYMBOLS
cos_tb
